Script started on 2020-02-27 11:47:06-0500
]0;boutell@roxnsox: ~/apostrophecms/apostrophe-workflow[01;32mboutell@roxnsox[00m:[01;34m~/apostrophecms/apostrophe-workflow[00m$ npm test

> apostrophe-workflow@2.32.0 test /home/boutell/apostrophecms/apostrophe-workflow
> mocha && eslint .


[0m[0m
[0m  Workflow Core[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  1) should be a property of the apos object[0m
  [31m  2) should create parked pages with prefixes[0m

[0m  Workflow Reorganize[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  3) should be a property of the apos object[0m
  [31m  4) insert page1 and page2 as peers initially[0m
  [31m  5) page1 and page2 are peers in default-draft locale[0m
  [31m  6) page1 and page2 are peers in default locale[0m
  [31m  7) should be able to move page2 under page1 in default-draft[0m
  [31m  8) meanwhile in live locale, page2 should still be a peer[0m
  [31m  9) should be able to commit page1[0m
  [31m  10) should be able to commit page2[0m
  [31m  11) now in live locale page2 should be nested under page1[0m
  [31m  12) meanwhile in fr-draft page2 is still a peer of page1[0m
  [31m  13) export both commits to fr-draft locale[0m
  [31m  14) after exports page2 is a child of page1 in fr-draft[0m
  [31m  15) ... but still a peer in fr (live)[0m
  [31m  16) ... and still a peer in the unrelated en-draft[0m
  [31m  17) can force export page1 and page2 to en-draft[0m
  [31m  18) after force exports page2 is a child of page1 in en-draft[0m

[0m  Workflow Reorganize with replicate:false[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  19) should be a property of the apos object[0m
  [31m  20) insert page1 and page2 as peers initially[0m
  [31m  21) page1 and page2 are peers in default-draft locale[0m
  [31m  22) page1 and page2 are peers in default locale[0m
  [31m  23) should be able to move page2 under page1 in default-draft[0m
  [31m  24) meanwhile in live locale, page2 should still be a peer[0m
  [31m  25) should be able to commit page1[0m
  [31m  26) should be able to commit page2[0m
  [31m  27) now in live locale page2 should be nested under page1[0m
  [32m  âœ“[0m[90m meanwhile in fr-draft page2 does not exist yet[0m
  [31m  28) export both commits to fr-draft locale[0m
  [31m  29) after exports page2 is a child of page1 in fr-draft[0m
  [31m  30) ... and in fr (live)[0m
  [32m  âœ“[0m[90m ... and still nonexistent in the unrelated en-draft[0m
  [31m  31) can force export page1 and page2 to en-draft[0m
  [31m  32) after force exports page2 is a child of page1 in en-draft[0m
  [32m  âœ“[0m[90m ... and still nonexistent in the unrelated es-draft[0m
  [31m  33) can force export page2 and page1 to es-draft, in that order (reversed)[0m
  [31m  34) after force exports page1 and page2 are peers, in reverse order, in es-draft because the parent was not available when the child first arrived[0m

[0m  Workflow Core[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  35) should be a property of the apos object[0m
  [31m  36) should make sure all of the expected indexes are configured[0m
  [31m  37) parked homepage exists in default-draft locale[0m
  [31m  38) parked homepage exists in default locale[0m
  [32m  âœ“[0m[90m should be able to use db to insert documents[0m
  [32m  âœ“[0m[90m should have a find method on pages that returns a cursor[0m
  [31m  39) should be able to find the parked homepage[0m
  [31m  40) should be able to find just a single page[0m
  [31m  41) should be able to include the ancestors of a page[0m
  [31m  42) should be able to include just one ancestor of a page, i.e. the parent[0m
  [31m  43) should be able to include the children of the ancestors of a page[0m
  [31m  44) is able to insert a new page[0m
  [31m  45) is able to insert a new page in the correct order[0m
  [31m  46) is able to insert a new page in the correct order in both locales[0m
TypeError: workflow.includeType is not a function
    at Object.self.workflowOnPermissions (/home/boutell/apostrophecms/apostrophe-workflow/lib/modules/apostrophe-workflow-permissions/index.js:33:21)
    at Object.wrapper (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/@sailshq/lodash/lib/index.js:3772:19)
    at Object.self.emit (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/index.js:106:19)
    at filter (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:224:17)
    at Object.self._check (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:190:14)
    at Object.self.can (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:32:17)
    at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:105:16
    at arrayEach (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/@sailshq/lodash/lib/index.js:1463:13)
    at Function.<anonymous> (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/@sailshq/lodash/lib/index.js:3525:13)
    at Object.self.annotate (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:104:7)
    at after (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:543:31)
    at self.afters.(anonymous function) (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:173:11)
    at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1452:18
    at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
    at iterate (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:262:13)
    at Immediate.<anonymous> (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:274:29)
    at Immediate.<anonymous> (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:44:16)
    at Immediate.wrapper [as _onImmediate] (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/@sailshq/lodash/lib/index.js:3772:19)
    at runCallback (timers.js:810:20)
    at tryOnImmediate (timers.js:768:5)
    at processImmediate [as _immediateCallback] (timers.js:745:5)
  [31m  47) is able to move root/parent/sibling/cousin after root/parent[0m
TypeError: workflow.includeType is not a function
    at Object.self.workflowOnPermissions (/home/boutell/apostrophecms/apostrophe-workflow/lib/modules/apostrophe-workflow-permissions/index.js:33:21)
    at Object.wrapper (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/@sailshq/lodash/lib/index.js:3772:19)
    at Object.self.emit (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/index.js:106:19)
    at filter (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:224:17)
    at Object.self._check (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:190:14)
    at Object.self.can (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:32:17)
    at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:105:16
    at arrayEach (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/@sailshq/lodash/lib/index.js:1463:13)
    at Function.<anonymous> (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/@sailshq/lodash/lib/index.js:3525:13)
    at Object.self.annotate (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:104:7)
    at after (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:543:31)
    at self.afters.(anonymous function) (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:173:11)
    at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1452:18
    at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
    at iterate (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:262:13)
    at Immediate.<anonymous> (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:274:29)
    at Immediate.<anonymous> (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:44:16)
    at Immediate.wrapper [as _onImmediate] (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/@sailshq/lodash/lib/index.js:3772:19)
    at runCallback (timers.js:810:20)
    at tryOnImmediate (timers.js:768:5)
    at processImmediate [as _immediateCallback] (timers.js:745:5)
  [31m  48) is able to move root/cousin before root/parent/child[0m
TypeError: workflow.includeType is not a function
    at Object.self.workflowOnPermissions (/home/boutell/apostrophecms/apostrophe-workflow/lib/modules/apostrophe-workflow-permissions/index.js:33:21)
    at Object.wrapper (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/@sailshq/lodash/lib/index.js:3772:19)
    at Object.self.emit (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/index.js:106:19)
    at filter (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:224:17)
    at Object.self._check (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:190:14)
    at Object.self.can (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:32:17)
    at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:105:16
    at arrayEach (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/@sailshq/lodash/lib/index.js:1463:13)
    at Function.<anonymous> (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/@sailshq/lodash/lib/index.js:3525:13)
    at Object.self.annotate (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:104:7)
    at after (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:543:31)
    at self.afters.(anonymous function) (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:173:11)
    at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1452:18
    at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
    at iterate (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:262:13)
    at Immediate.<anonymous> (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:274:29)
    at Immediate.<anonymous> (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:44:16)
    at Immediate.wrapper [as _onImmediate] (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/@sailshq/lodash/lib/index.js:3772:19)
    at runCallback (timers.js:810:20)
    at tryOnImmediate (timers.js:768:5)
    at processImmediate [as _immediateCallback] (timers.js:745:5)
  [31m  49) is able to move root/parent/cousin inside root/parent/sibling[0m
TypeError: workflow.includeType is not a function
    at Object.self.workflowOnPermissions (/home/boutell/apostrophecms/apostrophe-workflow/lib/modules/apostrophe-workflow-permissions/index.js:33:21)
    at Object.wrapper (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/@sailshq/lodash/lib/index.js:3772:19)
    at Object.self.emit (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/index.js:106:19)
    at filter (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:224:17)
    at Object.self._check (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:190:14)
    at Object.self.can (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:32:17)
    at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:105:16
    at arrayEach (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/@sailshq/lodash/lib/index.js:1463:13)
    at Function.<anonymous> (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/@sailshq/lodash/lib/index.js:3525:13)
    at Object.self.annotate (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:104:7)
    at after (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:543:31)
    at self.afters.(anonymous function) (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:173:11)
    at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1452:18
    at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
    at iterate (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:262:13)
    at Immediate.<anonymous> (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:274:29)
    at Immediate.<anonymous> (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:44:16)
    at Immediate.wrapper [as _onImmediate] (/home/boutell/apostrophecms/apostrophe-workflow/node_modules/@sailshq/lodash/lib/index.js:3772:19)
    at runCallback (timers.js:810:20)
    at tryOnImmediate (timers.js:768:5)
    at processImmediate [as _immediateCallback] (timers.js:745:5)
  [31m  50) moving /parent into /another-parent should also move /parent/sibling[0m
  [32m  âœ“[0m[90m should detect that the home page is an ancestor of any page except itself[0m
  [32m  âœ“[0m[90m should detect a tab as the ancestor of its great grandchild but not someone else's[0m
  [31m  51) is able to "move" parent to the trash[0m
  [31m  52) inserting a piece fires afterInsert handler for each locale version[0m
  [31m  53) localization urls make sense without global prefix[0m
  [31m  54) localization urls make sense with global prefix[0m

[0m  Workflow Subdomains and Prefixes[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  55) should be a property of the apos object[0m
  [31m  56) can find a hostname-determined locale via middleware[0m
  [31m  57) can find a jointly-determined locale via middleware - case 1[0m
  [31m  58) can find a jointly-determined locale via middleware - case 2[0m
  [31m  59) can detect a root-level locale via middleware - case 1[0m
  [31m  60) can detect a root-level locale via middleware - case 2[0m
  [31m  61) can find a defaultLocaleByHostname-determined locale via middleware[0m
  [31m  62) can find a jointly determined locale via middleware when a defaultLocaleByHostname is also present[0m
  [31m  63) can detect a jointly determined private locale via prefix when we have permission[0m
  [31m  64) cannot detect a jointly determined private locale via prefix when we do not have permission[0m
  [31m  65) can detect a hostname determined private locale via hostname when we have permission[0m
  [31m  66) cannot detect hostname determined private locale via prefix when we do not have permission[0m
  [31m  67) can detect a defaultLocaleByHostname-determined private locale via hostname when we have permission[0m
  [31m  68) cannot detect defaultLocaleByHostname-determined private locale via prefix when we do not have permission[0m
  [31m  69) does not misinterpret an API URL as cause for a locale change[0m
  [31m  70) does not misinterpret a bad asset URL as cause for a locale change[0m
  [31m  71) can detect a root-level locale via middleware - case 3[0m
  [31m  72) can detect a root-level locale via middleware - case 4[0m
  [31m  73) can differentiate between locales which differ by hostname, but share a prefix - case 1[0m
  [31m  74) can differentiate between locales which differ by hostname, but share a prefix - case 2[0m
  [31m  75) can default the locale reasonably[0m
  [31m  76) can patch a draft with a modification to a widget[0m
  [31m  77) can apply a patch that moves a widget without altering it[0m
  [31m  78) order comes out right in patch when swapping just two[0m
  [31m  79) order comes out right in patch when adding a widget with subwidgets[0m
  [31m  80) order change at top level does not delete subwidgets[0m
  [31m  81) addition at top level works properly in the middle[0m
  [31m  82) append produces the right order with 2 items[0m
  [32m  âœ“[0m[90m getCriteriaAcrossLocales throws exception if doc has no workflowGuid[0m
  [31m  83) getCriteriaAcrossLocales produces nice response with workflowGuid[0m
  [31m  84) getCriteriaAcrossLocales respects mode === "both"[0m
  [31m  85) getCriteriaAcrossLocales respects mode === "draft"[0m
  [31m  86) getCriteriaAcrossLocales respects mode === "live"[0m
  [31m  87) getCriteriaAcrossLocales respects locales === "all"[0m
  [31m  88) getCriteriaAcrossLocales respects permissions[0m
  [31m  89) setPropertiesAcrossLocales works[0m
  [31m  90) anon can fetch public fr home page[0m
  [32m  âœ“[0m[90m anon cannot fetch private default home page[0m
  [31m  91) user with private-locales permission can fetch private default home page[0m
  [31m  92) guessLocale produces sensible results[0m

[0m  Workflow Subdomains and Prefixes[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  93) should be a property of the apos object[0m
  [31m  94) can find a hostname-determined locale via middleware[0m
  [31m  95) can find a jointly-determined locale via middleware - case 1[0m
  [31m  96) can find a jointly-determined locale via middleware - case 2[0m
  [31m  97) can detect a root-level locale via middleware - case 1[0m
  [31m  98) can detect a root-level locale via middleware - case 2[0m
  [31m  99) can find a defaultLocaleByHostname-determined locale via middleware[0m
  [31m  100) can find a jointly determined locale via middleware when a defaultLocaleByHostname is also present[0m
  [31m  101) can detect a jointly determined private locale via prefix when we have permission[0m
  [31m  102) cannot detect a jointly determined private locale via prefix when we do not have permission[0m
  [31m  103) can detect a hostname determined private locale via hostname when we have permission[0m
  [31m  104) cannot detect hostname determined private locale via prefix when we do not have permission[0m
  [31m  105) can detect a defaultLocaleByHostname-determined private locale via hostname when we have permission[0m
  [31m  106) cannot detect defaultLocaleByHostname-determined private locale via prefix when we do not have permission[0m
  [31m  107) does not misinterpret an API URL as cause for a locale change[0m
  [31m  108) does not misinterpret a bad asset URL as cause for a locale change[0m
  [31m  109) can detect a root-level locale via middleware - case 3[0m
  [31m  110) can detect a root-level locale via middleware - case 4[0m
  [31m  111) can differentiate between locales which differ by hostname, but share a prefix - case 1[0m
  [31m  112) can differentiate between locales which differ by hostname, but share a prefix - case 2[0m
  [31m  113) can default the locale reasonably[0m
  [31m  114) can patch a draft with a modification to a widget[0m
  [31m  115) can apply a patch that moves a widget without altering it[0m
  [31m  116) order comes out right in patch when swapping just two[0m
  [31m  117) order comes out right in patch when adding a widget with subwidgets[0m
  [31m  118) order change at top level does not delete subwidgets[0m
  [31m  119) addition at top level works properly in the middle[0m
  [31m  120) append produces the right order with 2 items[0m
  [32m  âœ“[0m[90m getCriteriaAcrossLocales throws exception if doc has no workflowGuid[0m
  [31m  121) getCriteriaAcrossLocales produces nice response with workflowGuid[0m
  [31m  122) getCriteriaAcrossLocales respects mode === "both"[0m
  [31m  123) getCriteriaAcrossLocales respects mode === "draft"[0m
  [31m  124) getCriteriaAcrossLocales respects mode === "live"[0m
  [31m  125) getCriteriaAcrossLocales respects locales === "all"[0m
  [31m  126) getCriteriaAcrossLocales respects permissions[0m
  [31m  127) setPropertiesAcrossLocales works[0m
  [31m  128) anon can fetch public fr home page[0m
  [32m  âœ“[0m[90m anon cannot fetch private default home page[0m
  [31m  129) user with private-locales permission can fetch private default home page[0m
  [31m  130) guessLocale produces sensible results[0m

[0m  Workflow Add Missing Locales Inheritance And Prefix Changes[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  131) should be a property of the apos object[0m
  [32m  âœ“[0m[90m can insert docs at a low level for test purposes[0m
  [31m  132) can execute add-missing-locales task[0m
  [31m  133) missing locales now have copies inherited from correct ancestors[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  134) can spin up second instance with same db but different prefixes and more locales[0m
  [31m  135) new locale appears, existing locales have updated prefixes[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  136) can spin up third instance where a prefix is removed[0m
  [31m  137) prefix removed[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  138) can spin up fourth instance with no prefix config[0m
  [31m  139) prefix removed from everything[0m

[0m  Workflow API[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  140) should be a property of the apos object[0m
  [31m  141) Test add draft product to db as draft[0m
  [31m  142) Commit a change[0m
  [31m  143) Check for live document after commit[0m
  [31m  144) Commmit a change[0m
  [31m  145) Check for live document after commit[0m
  [31m  146) Commit a change that deletes a property[0m
  [31m  147) Check for live document after commit: no more tags property[0m
  [31m  148) Test revert[0m
  [31m  149) Test revert to live[0m
  [31m  150) 1 doc committable after a modification to product, 0 after commit[0m

[0m  Workflow dereplicate task[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  151) should be a property of the apos object[0m
  [31m  152) newly inserted subpage gets replicated initially[0m
  [31m  153) run dereplication task without crashing[0m
  [31m  154) newly inserted subpage is no longer replicated to extra locales[0m
  [31m  155) home page should still be replicated[0m
  [31m  156) global doc page should still be replicated[0m

[0m  test global def[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  157) global should exist on the apos object[0m
  [31m  158) should populate def values of schema properties across locales at insert time[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  159) global should exist on the second apos object[0m
  [31m  160) should populate def values of schema properties at update time[0m

[0m  Override Options[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  161) should be a property of the apos object[0m
  [32m  âœ“[0m[90m verify disableExportAfterCommit === true for all global docs[0m
  [31m  162) verify simulated admin login and that "exportAfterCommit":false comes through[0m

[0m  Workflow with replicateAcrossLocales set to false: initial locales[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  163) should be a property of the apos object[0m
  [31m  164) home page should be replicated[0m
  [31m  165) global doc page should be replicated[0m
  [31m  166) parked test page should be replicated[0m
  [31m  167) newly inserted subpage is only replicated draft/live[0m
  [31m  168) make sure locale of all docs can be distinguished easily for testing who replicated from whom[0m
  [31m  169) insert test products and establish relationships[0m
  [31m  170) "after all" hook[0m

[0m  Workflow with replicateAcrossLocales set to false: expanded locales[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  171) should be a property of the apos object[0m
  [31m  172) home page should be replicated[0m
  [31m  173) global doc page should be replicated[0m
  [31m  174) parked test page should be replicated[0m
  [31m  175) es-mx-draft parked page should get content of es-draft, not default[0m
  [31m  176) Normally inserted subpage exists but was not replicated to new locale[0m

[0m  Workflow replication of related docs for new locales: initial locales[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  177) should be a property of the apos object[0m
  [31m  178) home page should be replicated[0m
  [31m  179) global doc page should be replicated[0m
  [31m  180) parked test page should be replicated[0m
  [31m  181) inserted subpage without relationships is only replicated draft/live[0m
  [31m  182) newly inserted subtree is initially only replicated draft/live[0m
  [31m  183) secondary newly inserted subtree is initially only replicated draft/live[0m
  [31m  184) make sure locale of all docs can be distinguished easily for testing who replicated from whom[0m
  [31m  185) insert test products and establish relationships[0m
  [31m  186) "after all" hook[0m

[0m  Workflow replication of related docs for new locales: expanded locales and check of relationships[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  187) should be a property of the apos object[0m
  [31m  188) home page should be replicated everywhere, never in trash[0m
  [31m  189) first product should be replicated to new locale due to relationship with homepage, not in trash[0m
  [31m  190) homepage of new locale should correctly reference first product in new locale, not in trash[0m
  [31m  191) fifth product should be replicated to new locale due to recursive relationship with homepage, not in trash[0m
  [31m  192) products in new locale should correctly reference each other, not in trash[0m
  [31m  193) sixth product should NOT be replicated because it lacks a recursive relationship with homepage[0m
  [31m  194) global doc page should be replicated everywhere, not in trash[0m
  [31m  195) parked test page should be replicated to all locales[0m
  [31m  196) es-mx-draft parked page should get content of es-draft, not default[0m
  [31m  197) First normally inserted subpage exists but was not replicated to new locale[0m
  [31m  198) Normally inserted subtree that is referenced by joins should be replicated to new locale at correct page tree level[0m
  [31m  199) Grandchild replicated via relationship is available in new locale via children({ depth: 2 })[0m
  [31m  200) Child not replicated via relationship is not available in new locale via children({ depth: 1 })[0m
  [31m  201) Replicated grandchild whose parent is not replicated appears in new locale[0m
  [31m  202) Replicated grandchild whose parent is not replicated appears in new locale as direct child of homepage[0m

[0m  Resolve Relationships[0m
WARNING: No session secret provided, please set the `secret` property of the `session` property of the apostrophe-express module in app.js
  [31m  203) should be a property of the apos object[0m
  [31m  204) Add products and specialists as drafts, with joins; confirm relationships mapped correctly in new locale[0m


[92m [0m[32m 13 passing[0m[90m (13s)[0m
[31m  204 failing[0m

[0m  1) Workflow Core
       should be a property of the apos object:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  2) Workflow Core
       should create parked pages with prefixes:
[0m[31m     AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/parkedPages.js:118:7
      at <anonymous>
      at process._tickCallback (internal/process/next_tick.js:189:7)
[0m
[0m  3) Workflow Reorganize
       should be a property of the apos object:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  4) Workflow Reorganize
       insert page1 and page2 as peers initially:
[0m[31m     Error: parent not found[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-pages/lib/api.js:66:31
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper [as _onImmediate] (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  5) Workflow Reorganize
       page1 and page2 are peers in default-draft locale:
[0m[31m     AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganize.js:196:7
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  6) Workflow Reorganize
       page1 and page2 are peers in default locale:
[0m[31m     AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganize.js:196:7
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  7) Workflow Reorganize
       should be able to move page2 under page1 in default-draft:
[0m[31m     TypeError: Cannot read property '_children' of undefined[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganize.js:101:26
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  8) Workflow Reorganize
       meanwhile in live locale, page2 should still be a peer:
[0m[31m     AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganize.js:196:7
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  9) Workflow Reorganize
       should be able to commit page1:
[0m[31m     TypeError: Cannot read property '_children' of undefined[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganize.js:120:26
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  10) Workflow Reorganize
       should be able to commit page2:
[0m[31m     TypeError: Cannot read property '_children' of undefined[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganize.js:131:26
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  11) Workflow Reorganize
       now in live locale page2 should be nested under page1:
[0m[31m     TypeError: Cannot read property '_children' of undefined[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganize.js:212:26
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  12) Workflow Reorganize
       meanwhile in fr-draft page2 is still a peer of page1:
[0m[31m     AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganize.js:196:7
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  13) Workflow Reorganize
       export both commits to fr-draft locale:
[0m[31m     TypeError: expecting a function but got [object Undefined][0m[90m
      at Function.Promise.promisify (node_modules/bluebird/js/release/promisify.js:270:15)
      at Context.<anonymous> (test/reorganize.js:146:30)
[0m
[0m  14) Workflow Reorganize
       after exports page2 is a child of page1 in fr-draft:
[0m[31m     TypeError: Cannot read property '_children' of undefined[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganize.js:212:26
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  15) Workflow Reorganize
       ... but still a peer in fr (live):
[0m[31m     AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganize.js:196:7
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  16) Workflow Reorganize
       ... and still a peer in the unrelated en-draft:
[0m[31m     AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganize.js:196:7
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  17) Workflow Reorganize
       can force export page1 and page2 to en-draft:
[0m[31m     TypeError: expecting a function but got [object Undefined][0m[90m
      at Function.Promise.promisify (node_modules/bluebird/js/release/promisify.js:270:15)
      at Context.<anonymous> (test/reorganize.js:174:33)
[0m
[0m  18) Workflow Reorganize
       after force exports page2 is a child of page1 in en-draft:
[0m[31m     TypeError: Cannot read property '_children' of undefined[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganize.js:212:26
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  19) Workflow Reorganize with replicate:false
       should be a property of the apos object:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  20) Workflow Reorganize with replicate:false
       insert page1 and page2 as peers initially:
[0m[31m     Error: parent not found[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-pages/lib/api.js:66:31
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper [as _onImmediate] (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  21) Workflow Reorganize with replicate:false
       page1 and page2 are peers in default-draft locale:
[0m[31m     AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganizeReplicateFalse.js:223:7
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  22) Workflow Reorganize with replicate:false
       page1 and page2 are peers in default locale:
[0m[31m     AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganizeReplicateFalse.js:223:7
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  23) Workflow Reorganize with replicate:false
       should be able to move page2 under page1 in default-draft:
[0m[31m     TypeError: Cannot read property '_children' of undefined[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganizeReplicateFalse.js:105:26
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  24) Workflow Reorganize with replicate:false
       meanwhile in live locale, page2 should still be a peer:
[0m[31m     AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganizeReplicateFalse.js:223:7
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  25) Workflow Reorganize with replicate:false
       should be able to commit page1:
[0m[31m     TypeError: Cannot read property '_children' of undefined[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganizeReplicateFalse.js:124:26
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  26) Workflow Reorganize with replicate:false
       should be able to commit page2:
[0m[31m     TypeError: Cannot read property '_children' of undefined[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganizeReplicateFalse.js:135:26
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  27) Workflow Reorganize with replicate:false
       now in live locale page2 should be nested under page1:
[0m[31m     TypeError: Cannot read property '_children' of undefined[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganizeReplicateFalse.js:257:26
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  28) Workflow Reorganize with replicate:false
       export both commits to fr-draft locale:
[0m[31m     TypeError: expecting a function but got [object Undefined][0m[90m
      at Function.Promise.promisify (node_modules/bluebird/js/release/promisify.js:270:15)
      at Context.<anonymous> (test/reorganizeReplicateFalse.js:150:30)
[0m
[0m  29) Workflow Reorganize with replicate:false
       after exports page2 is a child of page1 in fr-draft:
[0m[31m     TypeError: Cannot read property '_children' of undefined[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganizeReplicateFalse.js:257:26
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  30) Workflow Reorganize with replicate:false
       ... and in fr (live):
[0m[31m     TypeError: Cannot read property '_children' of undefined[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganizeReplicateFalse.js:257:26
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  31) Workflow Reorganize with replicate:false
       can force export page1 and page2 to en-draft:
[0m[31m     TypeError: expecting a function but got [object Undefined][0m[90m
      at Function.Promise.promisify (node_modules/bluebird/js/release/promisify.js:270:15)
      at Context.<anonymous> (test/reorganizeReplicateFalse.js:178:33)
[0m
[0m  32) Workflow Reorganize with replicate:false
       after force exports page2 is a child of page1 in en-draft:
[0m[31m     TypeError: Cannot read property '_children' of undefined[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganizeReplicateFalse.js:257:26
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  33) Workflow Reorganize with replicate:false
       can force export page2 and page1 to es-draft, in that order (reversed):
[0m[31m     TypeError: expecting a function but got [object Undefined][0m[90m
      at Function.Promise.promisify (node_modules/bluebird/js/release/promisify.js:270:15)
      at Context.<anonymous> (test/reorganizeReplicateFalse.js:201:33)
[0m
[0m  34) Workflow Reorganize with replicate:false
       after force exports page1 and page2 are peers, in reverse order, in es-draft because the parent was not available when the child first arrived:
[0m[31m     AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/reorganizeReplicateFalse.js:241:7
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  35) Workflow Core
       should be a property of the apos object:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  36) Workflow Core
       should make sure all of the expected indexes are configured:

      [31mUncaught AssertionError [ERR_ASSERTION]: 2 == 3[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-2[0m
      [32m+3[0m
      [0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test1.js:81:14
      at handleCallback (node_modules/mongodb/lib/utils.js:120:56)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb/lib/db.js:1586:5
      at handleCallback (node_modules/mongodb/lib/utils.js:120:56)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb/lib/cursor.js:861:16
      at handleCallback (node_modules/mongodb-core/lib/cursor.js:171:5)
      at setCursorDeadAndNotified (node_modules/mongodb-core/lib/cursor.js:505:3)
      at nextFunction (node_modules/mongodb-core/lib/cursor.js:660:7)
      at CommandCursor.Cursor.next [as _next] (node_modules/mongodb-core/lib/cursor.js:701:3)
      at fetchDocs (node_modules/mongodb/lib/cursor.js:857:10)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb/lib/cursor.js:880:7
      at handleCallback (node_modules/mongodb-core/lib/cursor.js:171:5)
      at nextFunction (node_modules/mongodb-core/lib/cursor.js:691:5)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb-core/lib/cursor.js:602:7
      at queryCallback (node_modules/mongodb-core/lib/cursor.js:232:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb-core/lib/connection/pool.js:469:18
      at _combinedTickCallback (internal/process/next_tick.js:132:7)
      at process._tickCallback (internal/process/next_tick.js:181:9)
[0m
[0m  37) Workflow Core
       parked homepage exists in default-draft locale:
[0m[31m     Uncaught AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test1.js:91:7
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper [as _onImmediate] (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  38) Workflow Core
       parked homepage exists in default locale:
[0m[31m     Uncaught AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test1.js:105:7
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper [as _onImmediate] (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  39) Workflow Core
       should be able to find the parked homepage:
[0m[31m     Uncaught AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test1.js:207:7
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper [as _onImmediate] (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  40) Workflow Core
       should be able to find just a single page:

      [31mUncaught AssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test1.js:219:7
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1160:20
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1455:20
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:264:21)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper [as _onImmediate] (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  41) Workflow Core
       should be able to include the ancestors of a page:

      [31mUncaught AssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test1.js:232:7
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1160:20
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1455:20
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:264:21)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper [as _onImmediate] (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  42) Workflow Core
       should be able to include just one ancestor of a page, i.e. the parent:

      [31mUncaught AssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test1.js:249:7
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1160:20
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1455:20
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:264:21)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper [as _onImmediate] (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  43) Workflow Core
       should be able to include the children of the ancestors of a page:

      [31mUncaught AssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test1.js:264:7
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1160:20
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1455:20
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:264:21)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper [as _onImmediate] (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  44) Workflow Core
       is able to insert a new page:

      [31mUncaught AssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test1.js:293:7
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-pages/lib/api.js:145:20
      at handleCallback (node_modules/mongodb/lib/utils.js:120:56)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb/lib/collection.js:1252:5
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb-core/lib/connection/pool.js:469:18
      at _combinedTickCallback (internal/process/next_tick.js:132:7)
      at process._tickCallback (internal/process/next_tick.js:181:9)
[0m
[0m  45) Workflow Core
       is able to insert a new page in the correct order:
[0m[31m     Uncaught TypeError: Cannot read property 'rank' of undefined[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test1.js:305:25
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper [as _onImmediate] (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  46) Workflow Core
       is able to insert a new page in the correct order in both locales:
[0m[31m     Uncaught TypeError: Cannot read property 'rank' of undefined[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test1.js:316:25
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper [as _onImmediate] (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  47) Workflow Core
       is able to move root/parent/sibling/cousin after root/parent:

      [31mUncaught AssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test1.js:333:7
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-pages/lib/api.js:145:20
      at handleCallback (node_modules/mongodb/lib/utils.js:120:56)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb/lib/collection.js:1252:5
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb-core/lib/connection/pool.js:469:18
      at _combinedTickCallback (internal/process/next_tick.js:132:7)
      at process._tickCallback (internal/process/next_tick.js:181:9)
[0m
[0m  48) Workflow Core
       is able to move root/cousin before root/parent/child:

      [31mUncaught AssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test1.js:357:7
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-pages/lib/api.js:145:20
      at handleCallback (node_modules/mongodb/lib/utils.js:120:56)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb/lib/collection.js:1252:5
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb-core/lib/connection/pool.js:469:18
      at _combinedTickCallback (internal/process/next_tick.js:132:7)
      at process._tickCallback (internal/process/next_tick.js:181:9)
[0m
[0m  49) Workflow Core
       is able to move root/parent/cousin inside root/parent/sibling:

      [31mUncaught AssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test1.js:380:7
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-pages/lib/api.js:145:20
      at handleCallback (node_modules/mongodb/lib/utils.js:120:56)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb/lib/collection.js:1252:5
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb-core/lib/connection/pool.js:469:18
      at _combinedTickCallback (internal/process/next_tick.js:132:7)
      at process._tickCallback (internal/process/next_tick.js:181:9)
[0m
[0m  50) Workflow Core
       moving /parent into /another-parent should also move /parent/sibling:

      [31mUncaught AssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test1.js:402:7
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-pages/lib/api.js:145:20
      at handleCallback (node_modules/mongodb/lib/utils.js:120:56)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb/lib/collection.js:1252:5
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb-core/lib/connection/pool.js:469:18
      at _combinedTickCallback (internal/process/next_tick.js:132:7)
      at process._tickCallback (internal/process/next_tick.js:181:9)
[0m
[0m  51) Workflow Core
       is able to "move" parent to the trash:
[0m[31m     Uncaught TypeError: Cannot read property '_ancestors' of undefined[0m[90m
      at self.find.permission.trash.ancestors.toObject (node_modules/apostrophe/lib/modules/apostrophe-pages/lib/api.js:675:27)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1160:20
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1455:20
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:264:21)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper [as _onImmediate] (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  52) Workflow Core
       inserting a piece fires afterInsert handler for each locale version:
[0m[31m     TypeError: workflow.includeType is not a function[0m[90m
      at Object.self.workflowOnPermissions (lib/modules/apostrophe-workflow-permissions/index.js:33:21)
      at Object.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
      at Object.self.emit (node_modules/apostrophe/index.js:106:19)
      at filter (node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:224:17)
      at Object.self._check (node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:190:14)
      at Object.self.can (node_modules/apostrophe/lib/modules/apostrophe-permissions/lib/api.js:32:17)
      at body (node_modules/apostrophe/lib/modules/apostrophe-pieces/lib/api.js:290:33)
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at ret (eval at makeNodePromisifiedEval (node_modules/bluebird/js/release/promisify.js:184:12), <anonymous>:13:39)
      at Object.self.insert (node_modules/apostrophe/lib/modules/apostrophe-pieces/lib/api.js:283:37)
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test1.js:496:22
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Function.Promise.attempt.Promise.try (node_modules/bluebird/js/release/method.js:39:29)
      at Context.<anonymous> (test/test1.js:495:23)
[0m
[0m  53) Workflow Core
       localization urls make sense without global prefix:
[0m[31m     TypeError: expecting a function but got [object Undefined][0m[90m
      at Function.Promise.promisify (node_modules/bluebird/js/release/promisify.js:270:15)
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test1.js:511:22
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  54) Workflow Core
       localization urls make sense with global prefix:
[0m[31m     TypeError: expecting a function but got [object Undefined][0m[90m
      at Function.Promise.promisify (node_modules/bluebird/js/release/promisify.js:270:15)
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test1.js:521:22
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  55) Workflow Subdomains and Prefixes
       should be a property of the apos object:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  56) Workflow Subdomains and Prefixes
       can find a hostname-determined locale via middleware:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddleware (test/test2-disable-anon-session.js:163:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:201:5)
[0m
[0m  57) Workflow Subdomains and Prefixes
       can find a jointly-determined locale via middleware - case 1:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddleware (test/test2-disable-anon-session.js:163:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:208:5)
[0m
[0m  58) Workflow Subdomains and Prefixes
       can find a jointly-determined locale via middleware - case 2:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddleware (test/test2-disable-anon-session.js:163:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:215:5)
[0m
[0m  59) Workflow Subdomains and Prefixes
       can detect a root-level locale via middleware - case 1:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddleware (test/test2-disable-anon-session.js:163:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:222:5)
[0m
[0m  60) Workflow Subdomains and Prefixes
       can detect a root-level locale via middleware - case 2:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddleware (test/test2-disable-anon-session.js:163:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:229:5)
[0m
[0m  61) Workflow Subdomains and Prefixes
       can find a defaultLocaleByHostname-determined locale via middleware:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddleware (test/test2-disable-anon-session.js:163:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:236:5)
[0m
[0m  62) Workflow Subdomains and Prefixes
       can find a jointly determined locale via middleware when a defaultLocaleByHostname is also present:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddleware (test/test2-disable-anon-session.js:163:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:243:5)
[0m
[0m  63) Workflow Subdomains and Prefixes
       can detect a jointly determined private locale via prefix when we have permission:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddlewareAdmin (test/test2-disable-anon-session.js:167:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:250:5)
[0m
[0m  64) Workflow Subdomains and Prefixes
       cannot detect a jointly determined private locale via prefix when we do not have permission:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddleware (test/test2-disable-anon-session.js:163:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:257:5)
[0m
[0m  65) Workflow Subdomains and Prefixes
       can detect a hostname determined private locale via hostname when we have permission:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddlewareAdmin (test/test2-disable-anon-session.js:167:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:264:5)
[0m
[0m  66) Workflow Subdomains and Prefixes
       cannot detect hostname determined private locale via prefix when we do not have permission:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddleware (test/test2-disable-anon-session.js:163:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:271:5)
[0m
[0m  67) Workflow Subdomains and Prefixes
       can detect a defaultLocaleByHostname-determined private locale via hostname when we have permission:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddlewareAdmin (test/test2-disable-anon-session.js:167:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:278:5)
[0m
[0m  68) Workflow Subdomains and Prefixes
       cannot detect defaultLocaleByHostname-determined private locale via prefix when we do not have permission:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddleware (test/test2-disable-anon-session.js:163:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:285:5)
[0m
[0m  69) Workflow Subdomains and Prefixes
       does not misinterpret an API URL as cause for a locale change:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddleware (test/test2-disable-anon-session.js:163:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:292:5)
[0m
[0m  70) Workflow Subdomains and Prefixes
       does not misinterpret a bad asset URL as cause for a locale change:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddleware (test/test2-disable-anon-session.js:163:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:299:5)
[0m
[0m  71) Workflow Subdomains and Prefixes
       can detect a root-level locale via middleware - case 3:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddleware (test/test2-disable-anon-session.js:163:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:306:5)
[0m
[0m  72) Workflow Subdomains and Prefixes
       can detect a root-level locale via middleware - case 4:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddleware (test/test2-disable-anon-session.js:163:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:313:5)
[0m
[0m  73) Workflow Subdomains and Prefixes
       can differentiate between locales which differ by hostname, but share a prefix - case 1:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddleware (test/test2-disable-anon-session.js:163:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:320:5)
[0m
[0m  74) Workflow Subdomains and Prefixes
       can differentiate between locales which differ by hostname, but share a prefix - case 2:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddleware (test/test2-disable-anon-session.js:163:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:327:5)
[0m
[0m  75) Workflow Subdomains and Prefixes
       can default the locale reasonably:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2-disable-anon-session.js:193:49)
      at tryMiddleware (test/test2-disable-anon-session.js:163:12)
      at Context.<anonymous> (test/test2-disable-anon-session.js:334:5)
[0m
[0m  76) Workflow Subdomains and Prefixes
       can patch a draft with a modification to a widget:
[0m[31m     TypeError: apos.modules.apostrophe-workflow.applyPatch is not a function[0m[90m
      at Context.<anonymous> (test/test2-disable-anon-session.js:367:41)
[0m
[0m  77) Workflow Subdomains and Prefixes
       can apply a patch that moves a widget without altering it:
[0m[31m     TypeError: apos.modules.apostrophe-workflow.applyPatch is not a function[0m[90m
      at Context.<anonymous> (test/test2-disable-anon-session.js:407:41)
[0m
[0m  78) Workflow Subdomains and Prefixes
       order comes out right in patch when swapping just two:
[0m[31m     TypeError: apos.modules.apostrophe-workflow.applyPatch is not a function[0m[90m
      at Context.<anonymous> (test/test2-disable-anon-session.js:441:41)
[0m
[0m  79) Workflow Subdomains and Prefixes
       order comes out right in patch when adding a widget with subwidgets:
[0m[31m     TypeError: apos.modules.apostrophe-workflow.applyPatch is not a function[0m[90m
      at Context.<anonymous> (test/test2-disable-anon-session.js:475:41)
[0m
[0m  80) Workflow Subdomains and Prefixes
       order change at top level does not delete subwidgets:
[0m[31m     TypeError: apos.modules.apostrophe-workflow.applyPatch is not a function[0m[90m
      at Context.<anonymous> (test/test2-disable-anon-session.js:524:41)
[0m
[0m  81) Workflow Subdomains and Prefixes
       addition at top level works properly in the middle:
[0m[31m     TypeError: apos.modules.apostrophe-workflow.applyPatch is not a function[0m[90m
      at Context.<anonymous> (test/test2-disable-anon-session.js:583:41)
[0m
[0m  82) Workflow Subdomains and Prefixes
       append produces the right order with 2 items:
[0m[31m     TypeError: apos.modules.apostrophe-workflow.applyPatch is not a function[0m[90m
      at Context.<anonymous> (test/test2-disable-anon-session.js:635:41)
[0m
[0m  83) Workflow Subdomains and Prefixes
       getCriteriaAcrossLocales produces nice response with workflowGuid:

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at Context.<anonymous> (test/test2-disable-anon-session.js:675:5)
[0m
[0m  84) Workflow Subdomains and Prefixes
       getCriteriaAcrossLocales respects mode === "both":

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at Context.<anonymous> (test/test2-disable-anon-session.js:701:5)
[0m
[0m  85) Workflow Subdomains and Prefixes
       getCriteriaAcrossLocales respects mode === "draft":

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at Context.<anonymous> (test/test2-disable-anon-session.js:729:5)
[0m
[0m  86) Workflow Subdomains and Prefixes
       getCriteriaAcrossLocales respects mode === "live":

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at Context.<anonymous> (test/test2-disable-anon-session.js:755:5)
[0m
[0m  87) Workflow Subdomains and Prefixes
       getCriteriaAcrossLocales respects locales === "all":

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at Context.<anonymous> (test/test2-disable-anon-session.js:781:5)
[0m
[0m  88) Workflow Subdomains and Prefixes
       getCriteriaAcrossLocales respects permissions:

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at Context.<anonymous> (test/test2-disable-anon-session.js:839:5)
[0m
[0m  89) Workflow Subdomains and Prefixes
       setPropertiesAcrossLocales works:
[0m[31m     Uncaught AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test2-disable-anon-session.js:865:9
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper [as _onImmediate] (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  90) Workflow Subdomains and Prefixes
       anon can fetch public fr home page:
[0m[31m     Uncaught AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test2-disable-anon-session.js:906:7
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper [as _onImmediate] (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  91) Workflow Subdomains and Prefixes
       user with private-locales permission can fetch private default home page:
[0m[31m     Uncaught AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test2-disable-anon-session.js:931:7
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper [as _onImmediate] (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  92) Workflow Subdomains and Prefixes
       guessLocale produces sensible results:

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at Context.<anonymous> (test/test2-disable-anon-session.js:945:5)
[0m
[0m  93) Workflow Subdomains and Prefixes
       should be a property of the apos object:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  94) Workflow Subdomains and Prefixes
       can find a hostname-determined locale via middleware:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddleware (test/test2.js:159:12)
      at Context.<anonymous> (test/test2.js:197:5)
[0m
[0m  95) Workflow Subdomains and Prefixes
       can find a jointly-determined locale via middleware - case 1:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddleware (test/test2.js:159:12)
      at Context.<anonymous> (test/test2.js:204:5)
[0m
[0m  96) Workflow Subdomains and Prefixes
       can find a jointly-determined locale via middleware - case 2:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddleware (test/test2.js:159:12)
      at Context.<anonymous> (test/test2.js:211:5)
[0m
[0m  97) Workflow Subdomains and Prefixes
       can detect a root-level locale via middleware - case 1:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddleware (test/test2.js:159:12)
      at Context.<anonymous> (test/test2.js:218:5)
[0m
[0m  98) Workflow Subdomains and Prefixes
       can detect a root-level locale via middleware - case 2:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddleware (test/test2.js:159:12)
      at Context.<anonymous> (test/test2.js:225:5)
[0m
[0m  99) Workflow Subdomains and Prefixes
       can find a defaultLocaleByHostname-determined locale via middleware:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddleware (test/test2.js:159:12)
      at Context.<anonymous> (test/test2.js:232:5)
[0m
[0m  100) Workflow Subdomains and Prefixes
       can find a jointly determined locale via middleware when a defaultLocaleByHostname is also present:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddleware (test/test2.js:159:12)
      at Context.<anonymous> (test/test2.js:239:5)
[0m
[0m  101) Workflow Subdomains and Prefixes
       can detect a jointly determined private locale via prefix when we have permission:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddlewareAdmin (test/test2.js:163:12)
      at Context.<anonymous> (test/test2.js:246:5)
[0m
[0m  102) Workflow Subdomains and Prefixes
       cannot detect a jointly determined private locale via prefix when we do not have permission:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddleware (test/test2.js:159:12)
      at Context.<anonymous> (test/test2.js:253:5)
[0m
[0m  103) Workflow Subdomains and Prefixes
       can detect a hostname determined private locale via hostname when we have permission:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddlewareAdmin (test/test2.js:163:12)
      at Context.<anonymous> (test/test2.js:260:5)
[0m
[0m  104) Workflow Subdomains and Prefixes
       cannot detect hostname determined private locale via prefix when we do not have permission:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddleware (test/test2.js:159:12)
      at Context.<anonymous> (test/test2.js:267:5)
[0m
[0m  105) Workflow Subdomains and Prefixes
       can detect a defaultLocaleByHostname-determined private locale via hostname when we have permission:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddlewareAdmin (test/test2.js:163:12)
      at Context.<anonymous> (test/test2.js:274:5)
[0m
[0m  106) Workflow Subdomains and Prefixes
       cannot detect defaultLocaleByHostname-determined private locale via prefix when we do not have permission:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddleware (test/test2.js:159:12)
      at Context.<anonymous> (test/test2.js:281:5)
[0m
[0m  107) Workflow Subdomains and Prefixes
       does not misinterpret an API URL as cause for a locale change:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddleware (test/test2.js:159:12)
      at Context.<anonymous> (test/test2.js:288:5)
[0m
[0m  108) Workflow Subdomains and Prefixes
       does not misinterpret a bad asset URL as cause for a locale change:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddleware (test/test2.js:159:12)
      at Context.<anonymous> (test/test2.js:295:5)
[0m
[0m  109) Workflow Subdomains and Prefixes
       can detect a root-level locale via middleware - case 3:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddleware (test/test2.js:159:12)
      at Context.<anonymous> (test/test2.js:302:5)
[0m
[0m  110) Workflow Subdomains and Prefixes
       can detect a root-level locale via middleware - case 4:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddleware (test/test2.js:159:12)
      at Context.<anonymous> (test/test2.js:309:5)
[0m
[0m  111) Workflow Subdomains and Prefixes
       can differentiate between locales which differ by hostname, but share a prefix - case 1:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddleware (test/test2.js:159:12)
      at Context.<anonymous> (test/test2.js:316:5)
[0m
[0m  112) Workflow Subdomains and Prefixes
       can differentiate between locales which differ by hostname, but share a prefix - case 2:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddleware (test/test2.js:159:12)
      at Context.<anonymous> (test/test2.js:323:5)
[0m
[0m  113) Workflow Subdomains and Prefixes
       can default the locale reasonably:
[0m[31m     TypeError: Cannot read property 'middleware' of undefined[0m[90m
      at tryMiddlewareBody (test/test2.js:189:49)
      at tryMiddleware (test/test2.js:159:12)
      at Context.<anonymous> (test/test2.js:330:5)
[0m
[0m  114) Workflow Subdomains and Prefixes
       can patch a draft with a modification to a widget:
[0m[31m     TypeError: apos.modules.apostrophe-workflow.applyPatch is not a function[0m[90m
      at Context.<anonymous> (test/test2.js:363:41)
[0m
[0m  115) Workflow Subdomains and Prefixes
       can apply a patch that moves a widget without altering it:
[0m[31m     TypeError: apos.modules.apostrophe-workflow.applyPatch is not a function[0m[90m
      at Context.<anonymous> (test/test2.js:403:41)
[0m
[0m  116) Workflow Subdomains and Prefixes
       order comes out right in patch when swapping just two:
[0m[31m     TypeError: apos.modules.apostrophe-workflow.applyPatch is not a function[0m[90m
      at Context.<anonymous> (test/test2.js:437:41)
[0m
[0m  117) Workflow Subdomains and Prefixes
       order comes out right in patch when adding a widget with subwidgets:
[0m[31m     TypeError: apos.modules.apostrophe-workflow.applyPatch is not a function[0m[90m
      at Context.<anonymous> (test/test2.js:471:41)
[0m
[0m  118) Workflow Subdomains and Prefixes
       order change at top level does not delete subwidgets:
[0m[31m     TypeError: apos.modules.apostrophe-workflow.applyPatch is not a function[0m[90m
      at Context.<anonymous> (test/test2.js:520:41)
[0m
[0m  119) Workflow Subdomains and Prefixes
       addition at top level works properly in the middle:
[0m[31m     TypeError: apos.modules.apostrophe-workflow.applyPatch is not a function[0m[90m
      at Context.<anonymous> (test/test2.js:579:41)
[0m
[0m  120) Workflow Subdomains and Prefixes
       append produces the right order with 2 items:
[0m[31m     TypeError: apos.modules.apostrophe-workflow.applyPatch is not a function[0m[90m
      at Context.<anonymous> (test/test2.js:631:41)
[0m
[0m  121) Workflow Subdomains and Prefixes
       getCriteriaAcrossLocales produces nice response with workflowGuid:

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at Context.<anonymous> (test/test2.js:671:5)
[0m
[0m  122) Workflow Subdomains and Prefixes
       getCriteriaAcrossLocales respects mode === "both":

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at Context.<anonymous> (test/test2.js:697:5)
[0m
[0m  123) Workflow Subdomains and Prefixes
       getCriteriaAcrossLocales respects mode === "draft":

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at Context.<anonymous> (test/test2.js:725:5)
[0m
[0m  124) Workflow Subdomains and Prefixes
       getCriteriaAcrossLocales respects mode === "live":

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at Context.<anonymous> (test/test2.js:751:5)
[0m
[0m  125) Workflow Subdomains and Prefixes
       getCriteriaAcrossLocales respects locales === "all":

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at Context.<anonymous> (test/test2.js:777:5)
[0m
[0m  126) Workflow Subdomains and Prefixes
       getCriteriaAcrossLocales respects permissions:

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at Context.<anonymous> (test/test2.js:835:5)
[0m
[0m  127) Workflow Subdomains and Prefixes
       setPropertiesAcrossLocales works:
[0m[31m     Uncaught AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test2.js:861:9
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper [as _onImmediate] (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  128) Workflow Subdomains and Prefixes
       anon can fetch public fr home page:
[0m[31m     Uncaught AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test2.js:902:7
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper [as _onImmediate] (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  129) Workflow Subdomains and Prefixes
       user with private-locales permission can fetch private default home page:
[0m[31m     Uncaught AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test2.js:927:7
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper [as _onImmediate] (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  130) Workflow Subdomains and Prefixes
       guessLocale produces sensible results:

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at Context.<anonymous> (test/test2.js:941:5)
[0m
[0m  131) Workflow Add Missing Locales Inheritance And Prefix Changes
       should be a property of the apos object:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  132) Workflow Add Missing Locales Inheritance And Prefix Changes
       can execute add-missing-locales task:
[0m[31m     TypeError: apos.modules.apostrophe-workflow.addMissingLocalesTask is not a function[0m[90m
      at Context.<anonymous> (test/test3.js:115:48)
[0m
[0m  133) Workflow Add Missing Locales Inheritance And Prefix Changes
       missing locales now have copies inherited from correct ancestors:

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test3.js:121:7
      at <anonymous>
      at process._tickCallback (internal/process/next_tick.js:189:7)
[0m
[0m  134) Workflow Add Missing Locales Inheritance And Prefix Changes
       can spin up second instance with same db but different prefixes and more locales:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  135) Workflow Add Missing Locales Inheritance And Prefix Changes
       new locale appears, existing locales have updated prefixes:

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test3.js:211:7
      at <anonymous>
      at process._tickCallback (internal/process/next_tick.js:189:7)
[0m
[0m  136) Workflow Add Missing Locales Inheritance And Prefix Changes
       can spin up third instance where a prefix is removed:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  137) Workflow Add Missing Locales Inheritance And Prefix Changes
       prefix removed:

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test3.js:307:7
      at <anonymous>
      at process._tickCallback (internal/process/next_tick.js:189:7)
[0m
[0m  138) Workflow Add Missing Locales Inheritance And Prefix Changes
       can spin up fourth instance with no prefix config:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  139) Workflow Add Missing Locales Inheritance And Prefix Changes
       prefix removed from everything:

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/test3.js:392:7
      at <anonymous>
      at process._tickCallback (internal/process/next_tick.js:189:7)
[0m
[0m  140) Workflow API
       should be a property of the apos object:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  141) Workflow API
       Test add draft product to db as draft:
[0m[31m     TypeError: Cannot read property 'newInstance' of undefined[0m[90m
      at Context.it (test/testApi.js:54:33)
[0m
[0m  142) Workflow API
       Commit a change:
[0m[31m     TypeError: Cannot read property 'find' of undefined[0m[90m
      at getProductDraft (test/testApi.js:76:21)
      at fn (node_modules/async/lib/async.js:746:34)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1213:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:166:37
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:706:43
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:167:37
      at Object.async.waterfall (node_modules/async/lib/async.js:710:44)
      at Context.it (test/testApi.js:69:11)
[0m
[0m  143) Workflow API
       Check for live document after commit:
[0m[31m     TypeError: Cannot read property 'find' of undefined[0m[90m
      at Context.done (test/testApi.js:102:19)
[0m
[0m  144) Workflow API
       Commmit a change:
[0m[31m     TypeError: Cannot read property 'find' of undefined[0m[90m
      at getProductDraft (test/testApi.js:122:21)
      at fn (node_modules/async/lib/async.js:746:34)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1213:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:166:37
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:706:43
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:167:37
      at Object.async.waterfall (node_modules/async/lib/async.js:710:44)
      at Context.it (test/testApi.js:114:11)
[0m
[0m  145) Workflow API
       Check for live document after commit:
[0m[31m     TypeError: Cannot read property 'find' of undefined[0m[90m
      at Context.done (test/testApi.js:148:19)
[0m
[0m  146) Workflow API
       Commit a change that deletes a property:
[0m[31m     TypeError: Cannot read property 'find' of undefined[0m[90m
      at getProductDraft (test/testApi.js:168:21)
      at fn (node_modules/async/lib/async.js:746:34)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1213:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:166:37
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:706:43
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:167:37
      at Object.async.waterfall (node_modules/async/lib/async.js:710:44)
      at Context.it (test/testApi.js:160:11)
[0m
[0m  147) Workflow API
       Check for live document after commit: no more tags property:
[0m[31m     TypeError: Cannot read property 'find' of undefined[0m[90m
      at Context.done (test/testApi.js:194:19)
[0m
[0m  148) Workflow API
       Test revert:
[0m[31m     AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at Context.done (test/testApi.js:204:5)
[0m
[0m  149) Workflow API
       Test revert to live:
[0m[31m     TypeError: Cannot read property 'find' of undefined[0m[90m
      at getProduct (test/testApi.js:239:21)
      at fn (node_modules/async/lib/async.js:746:34)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1213:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:166:37
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:706:43
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:167:37
      at Object.async.waterfall (node_modules/async/lib/async.js:710:44)
      at Context.done (test/testApi.js:231:11)
[0m
[0m  150) Workflow API
       1 doc committable after a modification to product, 0 after commit:
[0m[31m     TypeError: Cannot read property 'find' of undefined[0m[90m
      at getProductDraft (test/testApi.js:264:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:718:13
      at iterate (node_modules/async/lib/async.js:262:13)
      at async.forEachOfSeries.async.eachOfSeries (node_modules/async/lib/async.js:281:9)
      at _parallel (node_modules/async/lib/async.js:717:9)
      at Object.async.series (node_modules/async/lib/async.js:739:9)
      at Context.done (test/testApi.js:258:11)
[0m
[0m  151) Workflow dereplicate task
       should be a property of the apos object:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  152) Workflow dereplicate task
       newly inserted subpage gets replicated initially:
[0m[31m     AssertionError [ERR_ASSERTION]: undefined == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/testDereplicate.js:75:7
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Promise._settlePromiseFromHandler (node_modules/bluebird/js/release/promise.js:512:31)
      at Promise._settlePromise (node_modules/bluebird/js/release/promise.js:569:18)
      at Promise._settlePromise0 (node_modules/bluebird/js/release/promise.js:614:10)
      at Promise._settlePromises (node_modules/bluebird/js/release/promise.js:694:18)
      at Promise._fulfill (node_modules/bluebird/js/release/promise.js:638:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/bluebird/js/release/nodeback.js:42:21
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1163:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:1209:30
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/apostrophe/lib/modules/apostrophe-docs/lib/cursor.js:1458:18
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:52:16
      at Immediate.<anonymous> (node_modules/async/lib/async.js:269:32)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:44:16)
      at Immediate.wrapper (node_modules/@sailshq/lodash/lib/index.js:3772:19)
[0m
[0m  153) Workflow dereplicate task
       run dereplication task without crashing:
[0m[31m     TypeError: task.callback is not a function[0m[90m
      at body (node_modules/apostrophe/lib/modules/apostrophe-tasks/index.js:90:28)
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at ret (eval at makeNodePromisifiedEval (node_modules/bluebird/js/release/promisify.js:184:12), <anonymous>:13:39)
      at Object.self.invoke (node_modules/apostrophe/lib/modules/apostrophe-tasks/index.js:79:39)
      at Context.<anonymous> (test/testDereplicate.js:88:23)
[0m
[0m  154) Workflow dereplicate task
       newly inserted subpage is no longer replicated to extra locales:
[0m[31m     AssertionError [ERR_ASSERTION]: null == true[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/testDereplicate.js:93:7
      at <anonymous>
      at process._tickCallback (internal/process/next_tick.js:189:7)
[0m
[0m  155) Workflow dereplicate task
       home page should still be replicated:

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/testDereplicate.js:111:7
      at <anonymous>
      at process._tickCallback (internal/process/next_tick.js:189:7)
[0m
[0m  156) Workflow dereplicate task
       global doc page should still be replicated:

      [31mAssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/testDereplicate.js:122:7
      at <anonymous>
      at process._tickCallback (internal/process/next_tick.js:189:7)
[0m
[0m  157) test global def
       global should exist on the apos object:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  158) test global def
       should populate def values of schema properties across locales at insert time:

      [31mUncaught AssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/testGlobalDef.js:67:7
      at handleCallback (node_modules/mongodb/lib/utils.js:120:56)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb/lib/cursor.js:861:16
      at handleCallback (node_modules/mongodb-core/lib/cursor.js:171:5)
      at setCursorNotified (node_modules/mongodb-core/lib/cursor.js:515:3)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb-core/lib/cursor.js:599:16
      at queryCallback (node_modules/mongodb-core/lib/cursor.js:232:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb-core/lib/connection/pool.js:469:18
      at _combinedTickCallback (internal/process/next_tick.js:132:7)
      at process._tickCallback (internal/process/next_tick.js:181:9)
[0m
[0m  159) test global def
       global should exist on the second apos object:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  160) test global def
       should populate def values of schema properties at update time:

      [31mUncaught AssertionError [ERR_ASSERTION]: false == true[0m
      [32m+ expected[0m [31m- actual[0m

      [31m-false[0m
      [32m+true[0m
      [0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/testGlobalDef.js:131:7
      at handleCallback (node_modules/mongodb/lib/utils.js:120:56)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb/lib/cursor.js:861:16
      at handleCallback (node_modules/mongodb-core/lib/cursor.js:171:5)
      at setCursorNotified (node_modules/mongodb-core/lib/cursor.js:515:3)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb-core/lib/cursor.js:599:16
      at queryCallback (node_modules/mongodb-core/lib/cursor.js:232:18)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/mongodb-core/lib/connection/pool.js:469:18
      at _combinedTickCallback (internal/process/next_tick.js:132:7)
      at process._tickCallback (internal/process/next_tick.js:181:9)
[0m
[0m  161) Override Options
       should be a property of the apos object:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  162) Override Options
       verify simulated admin login and that "exportAfterCommit":false comes through:
[0m[31m     RequestError: Error: connect ECONNREFUSED 127.0.0.1:7900[0m[90m
      at new RequestError (node_modules/request-promise-core/lib/errors.js:14:15)
      at Request.plumbing.callback (node_modules/request-promise-core/lib/plumbing.js:87:29)
      at Request.RP$callback [as _callback] (node_modules/request-promise-core/lib/plumbing.js:46:31)
      at self.callback (node_modules/request/request.js:185:22)
      at Request.onRequestError (node_modules/request/request.js:881:8)
      at Socket.socketErrorListener (_http_client.js:401:9)
      at emitErrorNT (internal/streams/destroy.js:66:8)
      at _combinedTickCallback (internal/process/next_tick.js:139:11)
      at process._tickCallback (internal/process/next_tick.js:181:9)
[0m
[0m  163) Workflow with replicateAcrossLocales set to false: initial locales
       should be a property of the apos object:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  164) Workflow with replicateAcrossLocales set to false: initial locales
       home page should be replicated:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateFalse.js:51:17)
[0m
[0m  165) Workflow with replicateAcrossLocales set to false: initial locales
       global doc page should be replicated:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateFalse.js:62:17)
[0m
[0m  166) Workflow with replicateAcrossLocales set to false: initial locales
       parked test page should be replicated:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateFalse.js:73:17)
[0m
[0m  167) Workflow with replicateAcrossLocales set to false: initial locales
       newly inserted subpage is only replicated draft/live:
[0m[31m     TypeError: Cannot read property 'tasks' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateFalse.js:84:20)
[0m
[0m  168) Workflow with replicateAcrossLocales set to false: initial locales
       make sure locale of all docs can be distinguished easily for testing who replicated from whom:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateFalse.js:105:17)
[0m
[0m  169) Workflow with replicateAcrossLocales set to false: initial locales
       insert test products and establish relationships:
[0m[31m     TypeError: Cannot read property 'tasks' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateFalse.js:114:22)
[0m
[0m  170) Workflow with replicateAcrossLocales set to false: initial locales
       "after all" hook:
[0m[31m     TypeError: Cannot read property 'destroy' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateFalse.js:14:10)
[0m
[0m  171) Workflow with replicateAcrossLocales set to false: expanded locales
       should be a property of the apos object:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  172) Workflow with replicateAcrossLocales set to false: expanded locales
       home page should be replicated:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateFalse.js:193:17)
[0m
[0m  173) Workflow with replicateAcrossLocales set to false: expanded locales
       global doc page should be replicated:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateFalse.js:204:17)
[0m
[0m  174) Workflow with replicateAcrossLocales set to false: expanded locales
       parked test page should be replicated:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateFalse.js:215:17)
[0m
[0m  175) Workflow with replicateAcrossLocales set to false: expanded locales
       es-mx-draft parked page should get content of es-draft, not default:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateFalse.js:226:17)
[0m
[0m  176) Workflow with replicateAcrossLocales set to false: expanded locales
       Normally inserted subpage exists but was not replicated to new locale:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateFalse.js:233:17)
[0m
[0m  177) Workflow replication of related docs for new locales: initial locales
       should be a property of the apos object:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  178) Workflow replication of related docs for new locales: initial locales
       home page should be replicated:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:50:17)
[0m
[0m  179) Workflow replication of related docs for new locales: initial locales
       global doc page should be replicated:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:61:17)
[0m
[0m  180) Workflow replication of related docs for new locales: initial locales
       parked test page should be replicated:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:72:17)
[0m
[0m  181) Workflow replication of related docs for new locales: initial locales
       inserted subpage without relationships is only replicated draft/live:
[0m[31m     TypeError: Cannot read property 'tasks' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:83:20)
[0m
[0m  182) Workflow replication of related docs for new locales: initial locales
       newly inserted subtree is initially only replicated draft/live:
[0m[31m     TypeError: Cannot read property 'tasks' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:107:20)
[0m
[0m  183) Workflow replication of related docs for new locales: initial locales
       secondary newly inserted subtree is initially only replicated draft/live:
[0m[31m     TypeError: Cannot read property 'tasks' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:173:20)
[0m
[0m  184) Workflow replication of related docs for new locales: initial locales
       make sure locale of all docs can be distinguished easily for testing who replicated from whom:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:239:17)
[0m
[0m  185) Workflow replication of related docs for new locales: initial locales
       insert test products and establish relationships:
[0m[31m     TypeError: Cannot read property 'tasks' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:249:22)
[0m
[0m  186) Workflow replication of related docs for new locales: initial locales
       "after all" hook:
[0m[31m     TypeError: Cannot read property 'destroy' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:13:10)
[0m
[0m  187) Workflow replication of related docs for new locales: expanded locales and check of relationships
       should be a property of the apos object:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  188) Workflow replication of related docs for new locales: expanded locales and check of relationships
       home page should be replicated everywhere, never in trash:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:337:17)
[0m
[0m  189) Workflow replication of related docs for new locales: expanded locales and check of relationships
       first product should be replicated to new locale due to relationship with homepage, not in trash:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:350:17)
[0m
[0m  190) Workflow replication of related docs for new locales: expanded locales and check of relationships
       homepage of new locale should correctly reference first product in new locale, not in trash:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at /home/boutell/apostrophecms/apostrophe-workflow/test/testReplicateRelated.js:360:19
      at tryCatcher (node_modules/bluebird/js/release/util.js:16:23)
      at Function.Promise.attempt.Promise.try (node_modules/bluebird/js/release/method.js:39:29)
      at Context.<anonymous> (test/testReplicateRelated.js:359:23)
[0m
[0m  191) Workflow replication of related docs for new locales: expanded locales and check of relationships
       fifth product should be replicated to new locale due to recursive relationship with homepage, not in trash:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:369:17)
[0m
[0m  192) Workflow replication of related docs for new locales: expanded locales and check of relationships
       products in new locale should correctly reference each other, not in trash:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:376:17)
[0m
[0m  193) Workflow replication of related docs for new locales: expanded locales and check of relationships
       sixth product should NOT be replicated because it lacks a recursive relationship with homepage:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:390:17)
[0m
[0m  194) Workflow replication of related docs for new locales: expanded locales and check of relationships
       global doc page should be replicated everywhere, not in trash:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:397:17)
[0m
[0m  195) Workflow replication of related docs for new locales: expanded locales and check of relationships
       parked test page should be replicated to all locales:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:408:17)
[0m
[0m  196) Workflow replication of related docs for new locales: expanded locales and check of relationships
       es-mx-draft parked page should get content of es-draft, not default:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:419:17)
[0m
[0m  197) Workflow replication of related docs for new locales: expanded locales and check of relationships
       First normally inserted subpage exists but was not replicated to new locale:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:426:17)
[0m
[0m  198) Workflow replication of related docs for new locales: expanded locales and check of relationships
       Normally inserted subtree that is referenced by joins should be replicated to new locale at correct page tree level:
[0m[31m     TypeError: Cannot read property 'docs' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:435:17)
[0m
[0m  199) Workflow replication of related docs for new locales: expanded locales and check of relationships
       Grandchild replicated via relationship is available in new locale via children({ depth: 2 }):
[0m[31m     TypeError: Cannot read property 'tasks' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:456:20)
[0m
[0m  200) Workflow replication of related docs for new locales: expanded locales and check of relationships
       Child not replicated via relationship is not available in new locale via children({ depth: 1 }):
[0m[31m     TypeError: Cannot read property 'tasks' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:467:20)
[0m
[0m  201) Workflow replication of related docs for new locales: expanded locales and check of relationships
       Replicated grandchild whose parent is not replicated appears in new locale:
[0m[31m     TypeError: Cannot read property 'tasks' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:478:20)
[0m
[0m  202) Workflow replication of related docs for new locales: expanded locales and check of relationships
       Replicated grandchild whose parent is not replicated appears in new locale as direct child of homepage:
[0m[31m     TypeError: Cannot read property 'tasks' of undefined[0m[90m
      at Context.<anonymous> (test/testReplicateRelated.js:485:20)
[0m
[0m  203) Resolve Relationships
       should be a property of the apos object:
[0m[31m     Uncaught Error: Cannot find module 'deep-get-set'[0m[90m
      at require (internal/module.js:11:18)
      at Object.<anonymous> (lib/api.js:3:12)
      at require (internal/module.js:11:18)
      at construct (index.js:100:5)
      at construct (node_modules/moog/index.js:278:21)
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/moog/index.js:288:22
      at /home/boutell/apostrophecms/apostrophe-workflow/node_modules/async/lib/async.js:181:20
      at iterate (node_modules/async/lib/async.js:262:13)
      at Immediate.<anonymous> (node_modules/async/lib/async.js:274:29)
      at Immediate._onImmediate (node_modules/async/lib/async.js:44:16)
[0m
[0m  204) Resolve Relationships
       Add products and specialists as drafts, with joins; confirm relationships mapped correctly in new locale:
[0m[31m     TypeError: Cannot read property 'newInstance' of undefined[0m[90m
      at Context.it (test/testResolveRelationships.js:81:40)
[0m


^CTerminated

]0;boutell@roxnsox: ~/apostrophecms/apostrophe-workflow[01;32mboutell@roxnsox[00m:[01;34m~/apostrophecms/apostrophe-workflow[00m$ npm install &[K
[?25l[[90m..................[0m] | rollbackFailedOptional: [34;40mverb[0m [35mnpm-session[0m 3cd6ea964c11e39[0m[K[[7m [27m[90m.................[0m] | preinstall:apostrophe-workflow: [32minfo[0m [35mlifecycle[0m apostroph[0m[K[[7m [27m[90m.................[0m] | preinstall:apostrophe-workflow: [32minfo[0m [35mlifecycle[0m apostroph[0m[K[[7m [27m[90m.................[0m] | preinstall:apostrophe-workflow: [32minfo[0m [35mlifecycle[0m apostroph[0m[K[[7m [27m[90m.................[0m] | preinstall:apostrophe-workflow: [32minfo[0m [35mlifecycle[0m apostroph[0m[K[[7m [27m[90m.................[0m] | preinstall:apostrophe-workflow: [32minfo[0m [35mlifecycle[0m apostroph[0m[K[[7m [27m[90m.................[0m] | preinstall:apostrophe-workflow: [32minfo[0m [35mlifecycle[0m apostroph[0m[K[[7m [27m[90m.................[0m] | preinstall:apostrophe-workflow: [32minfo[0m [35mlifecycle[0m apostroph[0m[K[[7m [27m[90m.................[0m] | preinstall:apostrophe-workflow: [32minfo[0m [35mlifecycle[0m apostroph[0m[K[[7m [27m[90m.................[0m] | preinstall:apostrophe-workflow: [32minfo[0m [35mlifecycle[0m apostroph[0m[K[[7m [27m[90m.................[0m] | preinstall:apostrophe-workflow: [32minfo[0m [35mlifecycle[0m apostroph[0m[K[[7m [27m[90m.................[0m] | preinstall:apostrophe-workflow: [32minfo[0m [35mlifecycle[0m apostroph[0m[K[[7m [27m[90m.................[0m] | preinstall:apostrophe-workflow: [32minfo[0m [35mlifecycle[0m apostroph[0m[K[[7m [27m[90m.................[0m] | preinstall:apostrophe-workflow: [32minfo[0m [35mlifecycle[0m apostroph[0m[K[[7m [27m[90m.................[0m] / loadIdealTree:loadAllDepsIntoIdealTree: [7msill[0m [35minstall[0m loa[0m[K[[7m  [27m[90m................[0m] \ loadDep:request-promise: [7msill[0m [35minstall[0m loadAllDepsIntoIde[0m[K[[7m    [27m[90m..............[0m] \ loadDevDep:mocha: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTree[0m[K[[7m    [27m[90m..............[0m] \ loadDep:yargs: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTree[0m[K[[7m    [27m[90m..............[0m] \ loadDep:use: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTree[0m[K[[7m    [27m[90m..............[0m] \ loadDep:static-extend: [7msill[0m [35minstall[0m loadAllDepsIntoIdeal[0m[K[[7m    [27m[90m..............[0m] \ loadDep:ret: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTree[0m[K[[7m    [27m[90m..............[0m] \ loadDep:sax: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTree[0m[K[[7m    [27m[90m..............[0m] \ loadDep:util-deprecate: [7msill[0m [35minstall[0m loadAllDepsIntoIdea[0m[K[[7m    [27m[90m..............[0m] \ loadDep:lodash.some: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTr[0m[K[[7m    [27m[90m..............[0m] \ loadDep:uid-safe: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTree[0m[K[[7m    [27m[90m..............[0m] \ loadDep:statuses: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTree[0m[K[[7m    [27m[90m..............[0m] \ loadDep:typechecker: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTr[0m[K[[7m    [27m[90m..............[0m] \ loadDep:uuid: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTree[0m[K[[7m    [27m[90m..............[0m] \ loadDep:path-is-absolute: [7msill[0m [35minstall[0m loadAllDepsIntoId[0m[K[[7m    [27m[90m..............[0m] \ loadDep:has-flag: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTree[0m[K[[7m    [27m[90m..............[0m] \ loadDep:xdg-basedir: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTr[0m[K[[7m    [27m[90m..............[0m] \ loadDep:pify: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTree[0m[K[[7m    [27m[90m..............[0m] \ loadDep:signal-exit: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTr[0m[K[[7m    [27m[90m..............[0m] \ loadDep:debug: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTree[0m[K[[7m    [27m[90m..............[0m] \ loadDep:stream-to: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTree[0m[K[[7m    [27m[90m..............[0m] \ loadDep:typedarray: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTre[0m[K[[7m    [27m[90m..............[0m] \ loadDep:is-promise: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTre[0m[K[[7m    [27m[90m..............[0m] \ loadDep:path-exists: [7msill[0m [35minstall[0m loadAllDepsIntoIdealTr[0m[K[[7m       [27m[90m...........[0m] | diffTrees: [7msill[0m [35minstall[0m generateActionsToTake[0m[K[[7m       [27m[90m...........[0m] | diffTrees: [7msill[0m [35minstall[0m generateActionsToTake[0m[K[[7m       [27m[90m...........[0m] | postinstall: [7msill[0m [35minstall[0m executeActions[0m[K[[7m       [27m[90m...........[0m] - extract:qs: [34;40mverb[0m [35mlock[0m using /home/boutell/.npm/_locks/st[0m[K[[7m       [27m[90m...........[0m] | extract:qs: [34;40mverb[0m [35mlock[0m using /home/boutell/.npm/_locks/st[0m[K[[7m       [27m[90m...........[0m] | extract:qs: [34;40mverb[0m [35mlock[0m using /home/boutell/.npm/_locks/st[0m[K[[7m           [27m[90m.......[0m] \ extract:nan: [7msill[0m [35mextract[0m nan@2.14.0 extracted to /home/[0m[K[[7m           [27m[90m.......[0m] \ extract:nan: [7msill[0m [35mextract[0m nan@2.14.0 extracted to /home/[0m[K[[7m           [27m[90m.......[0m] \ extract:nan: [7msill[0m [35mextract[0m nan@2.14.0 extracted to /home/[0m[K[[7m           [27m[90m.......[0m] | extract:nan: [7msill[0m [35mextract[0m nan@2.14.0 extracted to /home/[0m[K[[7m            [27m[90m......[0m] \ finalize:object-assign: [7msill[0m [35mfinalize[0m /home/boutell/apos[0m[K[[7m            [27m[90m......[0m] \ refresh-package-json:qs: [32;40mtiming[0m [35maction:finalize[0m Complete[0m[K[[7m            [27m[90m......[0m] \ refresh-package-json:qs: [32;40mtiming[0m [35maction:finalize[0m Complete[0m[K[[7m            [27m[90m......[0m] \ refresh-package-json:minimist: [7msill[0m [35mrefresh-package-json[0m[0m[K[[7m            [27m[90m......[0m] / postinstall: [32minfo[0m [35mlifecycle[0m qs@6.6.0~postinstall: qs@6.6[0m[K[[7m            [27m[90m......[0m] / postinstall: [32minfo[0m [35mlifecycle[0m qs@6.6.0~postinstall: qs@6.6[0m[K[[7m             [27m[90m.....[0m] | prepare:apostrophe-workflow: [32minfo[0m [35mlifecycle[0m apostrophe-w[0m[K[[7m             [27m[90m.....[0m] | prepare:apostrophe-workflow: [32minfo[0m [35mlifecycle[0m apostrophe-w[0m[K[K[?25h[37;40mnpm[0m [0m[30;43mWARN[0m[35m[0m apostrophe-workflow@2.32.0 requires a peer of apostrophe@^2.101.1 but none is installed. You must install peer dependencies yourself.
[0m[37;40mnpm[0m [0m[30;43mWARN[0m[35m[0m ajv-keywords@2.1.1 requires a peer of ajv@^5.0.0 but none is installed. You must install peer dependencies yourself.
[0m[37;40mnpm[0m [0m[30;43mWARN[0m [0m[35moptional[0m SKIPPING OPTIONAL DEPENDENCY: fsevents@1.2.9 (node_modules/fsevents):
[0m[37;40mnpm[0m [0m[30;43mWARN[0m [0m[35mnotsup[0m SKIPPING OPTIONAL DEPENDENCY: Unsupported platform for fsevents@1.2.9: wanted {"os":"darwin","arch":"any"} (current: {"os":"linux","arch":"x64"})
[0m
added 2 packages from 2 contributors and audited 4122 packages in 7.083s
found [91m66[0m vulnerabilities (1 [1mlow[0m, 2 [93mmoderate[0m, 63 [91mhigh[0m)
  run `npm audit fix` to fix them, or `npm audit` for details
]0;boutell@roxnsox: ~/apostrophecms/apostrophe-workflow[01;32mboutell@roxnsox[00m:[01;34m~/apostrophecms/apostrophe-workflow[00m$ exit
exit

Script done on 2020-02-27 11:47:38-0500
